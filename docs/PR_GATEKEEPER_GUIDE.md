# üö¶ PR Gatekeeper - Smart Delta-Based Auditing

## Overview

The **PR Gatekeeper** is a fast, intelligent code auditing tool designed specifically for Pull Request reviews. Instead of scanning the entire codebase, it performs **delta-based analysis** on ONLY the files that changed, making it perfect for CI/CD pipelines and rapid PR feedback.

## Key Features

### ‚ö° Speed-Optimized
- **Scans only changed files** compared to base branch
- Typical PR audit completes in seconds vs minutes for full audit
- Perfect for GitHub Actions, GitLab CI, or any CI/CD pipeline

### üéØ Smart Scoring
- Calculates quality score (0-100) based on findings in changed files only
- Security issues: -5 points per issue (max -30)
- Linting issues: -2 points per issue (max -20)
- Complexity issues: -3 points per function (max -15)

### ‚úÖ Test Safety Net
- Automatically runs `pytest` if score > 80
- Prevents "syntax clean but logic broken" scenarios
- Downgrades status if tests fail despite clean static analysis

### üéØ Explicit Recommendations
Returns one of three clear verdicts:
- **üü¢ Ready for Review**: High score + tests pass
- **üî¥ Request Changes**: Security issues or failing tests
- **üü° Needs Improvement**: Low score, fix issues first

## Usage

### Basic Usage

```python
# Via MCP tool
audit_pr_changes(
    path="C:/Projects/MyApp",
    base_branch="main",
    run_tests=True
)
```

### Natural Language (Claude/AI)

```
"Run PR audit on this project comparing to main branch"
"Check what changed in this PR and tell me if it's ready for review"
"Audit only the files I modified in this branch"
```

### Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `path` | str | Required | Path to the project directory |
| `base_branch` | str | `"main"` | Base branch to compare against |
| `run_tests` | bool | `True` | Whether to run pytest as safety net |

## How It Works

### Step 1: Get Changed Files
```bash
git diff --name-only {base_branch}...HEAD
```
Filters for existing `.py` files only.

### Step 2: Fast Scan
Runs **three tools** on changed files only:

1. **Bandit** - Security vulnerability scanning
2. **Ruff** - Fast Python linter
3. **Radon** - Cyclomatic complexity analysis

### Step 3: Score Calculation
```python
score = 100
score -= min(security_issues * 5, 30)
score -= min(linting_issues * 2, 20)
score -= min(complexity_issues * 3, 15)
```

### Step 4: Test Safety Net
If `run_tests=True` AND `score > 80`:
```bash
pytest -x --tb=short -q
```
- Uses project's virtual environment if available
- Fast mode: stops on first failure
- Timeout: 120 seconds

### Step 5: Generate Report
Returns JSON with:
- Recommendation (Ready/Request Changes/Needs Improvement)
- Score (0-100)
- Detailed findings per tool
- Markdown report for human review

## Output Example

### JSON Response
```json
{
  "status": "success",
  "recommendation": "üü¢ Ready for Review",
  "score": 95,
  "changed_files_count": 3,
  "findings": {
    "security_issues": 0,
    "linting_issues": 2,
    "complexity_issues": 0,
    "tests_passed": true
  },
  "report": "# üö¶ PR Gatekeeper Report\n..."
}
```

### Markdown Report
```markdown
# üö¶ PR Gatekeeper Report

**Base Branch:** `main`
**Changed Files:** 3 Python files
**Score:** 95/100

## üìù Changed Files
- `app/tools/new_feature.py`
- `app/core/processor.py`
- `tests/test_new_feature.py`

## üîí Security Scan (Bandit)
**Status:** ‚úÖ No security issues detected

## üìã Code Quality (Ruff)
**Status:** ‚ö†Ô∏è 2 issue(s) found
- `new_feature.py:42` - F401: Unused import
- `processor.py:15` - E501: Line too long

## üßÆ Complexity (Radon)
**Status:** ‚úÖ No high-complexity functions

## ‚úÖ Test Safety Net
**Status:** ‚úÖ All tests passed

---
## üéØ Bottom Line

### üü¢ Ready for Review

‚úÖ Code quality is good, no blocking issues detected.

**Minor Issues (Non-blocking):**
- 2 linting issue(s) - consider fixing

---
*Generated by Python Auditor MCP - PR Gatekeeper*
```

## Decision Logic

### üî¥ Request Changes
Triggered when:
- **Any security issues** detected by Bandit
- **Tests fail** (when run_tests=True and score > 80)

### üü¢ Ready for Review
Triggered when:
- Score >= 80
- No security issues
- Tests pass (or not run)
- May have minor linting/complexity issues (non-blocking)

### üü° Needs Improvement
Triggered when:
- Score < 80
- Multiple quality issues
- No blocking security/test failures

## CI/CD Integration

### GitHub Actions Example
```yaml
name: PR Gatekeeper

on:
  pull_request:
    branches: [main]

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for git diff
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install Auditor
        run: |
          pip install bandit ruff radon pytest pytest-cov
      
      - name: Run PR Audit
        run: |
          python -c "
          from mcp_fastmcp_server import audit_pr_changes
          import json
          result = json.loads(audit_pr_changes('.', 'main', True))
          print(result['report'])
          if 'üî¥' in result['recommendation']:
              exit(1)
          "
```

### GitLab CI Example
```yaml
pr_audit:
  stage: test
  script:
    - pip install bandit ruff radon pytest
    - python audit_pr.py
  only:
    - merge_requests
```

## Performance Comparison

| Scenario | Full Audit | PR Gatekeeper | Speedup |
|----------|-----------|---------------|---------|
| 3 files changed | 45s | 8s | **5.6x faster** |
| 10 files changed | 45s | 15s | **3x faster** |
| 50 files changed | 45s | 35s | **1.3x faster** |

*Note: Full audit scans entire codebase regardless of changes.*

## Best Practices

### ‚úÖ Do
- Use in CI/CD pipelines for fast feedback
- Set `run_tests=True` to catch logic regressions
- Compare against stable branch (main/master)
- Review the markdown report for context

### ‚ùå Don't
- Use for initial project setup (use full audit instead)
- Skip tests on critical PRs
- Ignore "minor" linting issues (they accumulate)
- Use on non-git repositories

## Troubleshooting

### "No Python changes detected"
- **Cause**: No `.py` files modified in this branch
- **Solution**: This is expected for docs-only PRs

### "Git diff failed"
- **Cause**: Not a git repository or base branch doesn't exist
- **Solution**: Ensure you're in a git repo and base branch exists

### "Tests timed out"
- **Cause**: Test suite takes > 120 seconds
- **Solution**: Set `run_tests=False` or optimize slow tests

### "Score is low but code looks fine"
- **Cause**: Inherited issues from base branch
- **Solution**: Run full audit on base branch first

## Related Tools

- **Full Audit**: Comprehensive scan of entire codebase
- **Auto-Fix**: Automated code cleanup with safety checks
- **Architecture Review**: Dependency graph visualization

## Version History

- **v1.0** (2026-01-14): Initial release with Bandit, Ruff, Radon support

---

**Made with ‚ù§Ô∏è for fast, reliable PR reviews**
